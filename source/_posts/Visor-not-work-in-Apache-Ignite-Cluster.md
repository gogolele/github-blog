title: Visor not work in Apache Ignite Cluster
date: 2015-10-23 14:47:16
categories: dev
tags: [ignite, visor]
---

I deploy a 6 nodes ignite for spark job. it works fine. However, when i hope to use the visor to do administration, i can not see the topology.

here is the config file.
![config](/image/conf.png)

And, when I enter the visor console, and open the config file. I encountered the "Empty topology"
![open](/image/open.png)
![top](/image/top.png)

Then I found the root cause, I use Static IP Based Discovery, i just config the IP Address List.
And I ran the visor on one of the nodes, so the visor uses port 47501, but the config file with static ips did not contain this server:port. Finally, this visor can not join the ignite cluster, and can not communicate with them.

configguer like this
```xml
<!-- Explicitly configure TCP discovery SPI to provide list of initial nodes. -->
     <property name="discoverySpi">
       <bean class="org.apache.ignite.spi.discovery.tcp.TcpDiscoverySpi">
         <property name="ipFinder">
           <bean class="org.apache.ignite.spi.discovery.tcp.ipfinder.vm.TcpDiscoveryVmIpFinder">
             <property name="addresses">
                   <list>
                       <value>10.1.24.244:47500..47509</value>
                       <value>10.1.24.245</value>
                       <value>10.1.24.246</value>
                       <value>10.1.24.247</value>
                       <value>10.1.24.248</value>
                       <value>10.1.24.249</value>
                   </list>
             </property>
```

you can find this ignite and visor are assigned 2 different ports of 47500/47501.
```shell
[tw79@s7spkhdp05 ~]$ sudo netstat -antup | grep 4750
[sudo] password for tw79:
tcp        0      0 :::47500                    :::*                        LISTEN      19044/java
tcp        0      0 :::47501                    :::*                        LISTEN      7869/java
tcp        0      0 ::ffff:10.1.41.245:47500    ::ffff:10.1.54.41:50145     ESTABLISHED 19044/java
tcp        0      0 ::ffff:10.1.41.245:40563    ::ffff:10.1.41.244:47500    ESTABLISHED 19044/java
tcp        0      0 ::ffff:10.1.41.245:47500    ::ffff:10.1.54.41:48436     ESTABLISHED 19044/java
tcp        0      0 ::ffff:10.1.41.245:47501    ::ffff:10.1.41.249:46017    ESTABLISHED 7869/java
tcp        0      0 ::1:47500                   ::1:55092                   ESTABLISHED 19044/java
tcp        0      0 ::1:55092                   ::1:47500                   ESTABLISHED 7869/java

```

Then we can use visor, looks cool.
```shell
visor> top
Hosts: 7
+================================================================================================================+
|   Int./Ext. IPs   |   Node ID8(@)    |                OS                 | CPUs |       MACs        | CPU Load |
+================================================================================================================+
| 0:0:0:0:0:0:0:1%1 | 1: 220D4A96(@n4) | Linux amd64 2.6.32-431.el6.x86_64 | 48   | B8:AC:6F:D2:75:18 | 0.20 %   |
| 10.1.41.248       |                  |                                   |      |                   |          |
| 127.0.0.1         |                  |                                   |      |                   |          |
+-------------------+------------------+-----------------------------------+------+-------------------+----------+
| 0:0:0:0:0:0:0:1%1 | 1: B055011F(@n1) | Linux amd64 2.6.32-431.el6.x86_64 | 48   | 84:2B:2B:F1:0A:A3 | 0.03 %   |
| 10.1.41.244       |                  |                                   |      |                   |          |
| 127.0.0.1         |                  |                                   |      |                   |          |
+-------------------+------------------+-----------------------------------+------+-------------------+----------+
| 0:0:0:0:0:0:0:1%1 | 1: 95A5FC58(@n3) | Linux amd64 2.6.32-431.el6.x86_64 | 48   | B8:AC:6F:D2:69:40 | 0.03 %   |
| 10.1.41.247       |                  |                                   |      |                   |          |
| 127.0.0.1         |                  |                                   |      |                   |          |
+-------------------+------------------+-----------------------------------+------+-------------------+----------+
| 0:0:0:0:0:0:0:1%1 | 1: 0B53ABEB(@n2) | Linux amd64 2.6.32-431.el6.x86_64 | 48   | B8:AC:6F:D2:70:60 | 0.03 %   |
| 10.1.41.246       |                  |                                   |      |                   |          |
| 127.0.0.1         |                  |                                   |      |                   |          |
+-------------------+------------------+-----------------------------------+------+-------------------+----------+
| 0:0:0:0:0:0:0:1%1 | 1: D61D3D12(@n5) | Linux amd64 2.6.32-431.el6.x86_64 | 48   | B8:AC:6F:D2:75:38 | 0.03 %   |
| 10.1.41.249       |                  |                                   |      |                   |          |
| 127.0.0.1         |                  |                                   |      |                   |          |
+-------------------+------------------+-----------------------------------+------+-------------------+----------+
| 0:0:0:0:0:0:0:1%1 | 1: 6D2A799D(@n0) | Linux amd64 2.6.32-431.el6.x86_64 | 48   | 00:26:B9:27:9C:2A | 0.13 %   |
| 10.1.41.245       |                  |                                   |      |                   |          |
| 127.0.0.1         |                  |                                   |      |                   |          |
+-------------------+------------------+-----------------------------------+------+-------------------+----------+
| 0:0:0:0:0:0:0:1%1 | 1: 8EB4755F(@n6) | Linux amd64 2.6.32-431.el6.x86_64 | 8    | 00:50:56:93:20:AB | 0.96 %   |
| 10.1.54.41        | 2: 3696A541(@n7) |                                   |      |                   |          |
| 127.0.0.1         | 3: D354BED1(@n8) |                                   |      |                   |          |
+----------------------------------------------------------------------------------------------------------------+

Summary:
+-------------------------------------+
| Total hosts    | 7                  |
| Total nodes    | 9                  |
| Total CPUs     | 296                |
| Avg. CPU load  | 0.37 %             |
| Avg. free heap | 77.00 %            |
| Avg. Up time   | 11:01:11           |
| Snapshot time  | 10/23/15, 14:55:16 |
+-------------------------------------+
visor> node
Select node from:
+=========================================================================+
| # |      Node ID8(@), IP       | Up Time  | CPUs | CPU Load | Free Heap |
+=========================================================================+
| 0 | 6D2A799D(@n0), 10.1.41.245 | 11:02:11 | 48   | 0.03 %   | 94.00 %   |
| 1 | B055011F(@n1), 10.1.41.244 | 11:01:31 | 48   | 0.03 %   | 66.00 %   |
| 2 | 0B53ABEB(@n2), 10.1.41.246 | 10:57:51 | 48   | 0.03 %   | 91.00 %   |
| 3 | 95A5FC58(@n3), 10.1.41.247 | 10:51:22 | 48   | 0.03 %   | 78.00 %   |
| 4 | 220D4A96(@n4), 10.1.41.248 | 10:39:46 | 48   | 0.03 %   | 66.00 %   |
| 5 | D61D3D12(@n5), 10.1.41.249 | 10:34:25 | 48   | 0.00 %   | 68.00 %   |
| 6 | 8EB4755F(@n6), 10.1.54.41  | 10:19:13 | 8    | 0.10 %   | 89.00 %   |
| 7 | 3696A541(@n7), 10.1.54.41  | 10:42:00 | 8    | 16.73 %  | 65.00 %   |
| 8 | D354BED1(@n8), 10.1.54.41  | 10:42:09 | 8    | 0.40 %   | 64.00 %   |
+-------------------------------------------------------------------------
visor> cache
Time of the snapshot: 10/23/15, 14:56:39
+===================================================================================================+
|     Name(@)     |    Mode     | Nodes |  Entries  |   Hits    |  Misses   |   Reads   |  Writes   |
+===================================================================================================+
| item_inc(@c0)   | PARTITIONED | 6     | min: 0    | min: 0    | min: 0    | min: 0    | min: 0    |
|                 |             |       | avg: 0.00 | avg: 0.00 | avg: 0.00 | avg: 0.00 | avg: 0.00 |
|                 |             |       | max: 0    | max: 0    | max: 0    | max: 0    | max: 0    |
+-----------------+-------------+-------+-----------+-----------+-----------+-----------+-----------+
| SORealtime(@c1) | PARTITIONED | 8     | min: 0    | min: 0    | min: 0    | min: 0    | min: 0    |
|                 |             |       | avg: 0.00 | avg: 0.00 | avg: 0.00 | avg: 0.00 | avg: 0.00 |
|                 |             |       | max: 0    | max: 0    | max: 0    | max: 0    | max: 0    |
+---------------------------------------------------------------------------------------------------+
visor> config
Select node from:
+=========================================================================+
| # |      Node ID8(@), IP       | Up Time  | CPUs | CPU Load | Free Heap |
+=========================================================================+
| 0 | 6D2A799D(@n0), 10.1.41.245 | 11:02:59 | 48   | 0.03 %   | 94.00 %   |
| 1 | B055011F(@n1), 10.1.41.244 | 11:02:19 | 48   | 0.00 %   | 66.00 %   |
| 2 | 0B53ABEB(@n2), 10.1.41.246 | 10:58:39 | 48   | 0.03 %   | 90.00 %   |
| 3 | 95A5FC58(@n3), 10.1.41.247 | 10:52:10 | 48   | 0.00 %   | 78.00 %   |
| 4 | 220D4A96(@n4), 10.1.41.248 | 10:40:34 | 48   | 0.03 %   | 66.00 %   |
| 5 | D61D3D12(@n5), 10.1.41.249 | 10:35:13 | 48   | 0.00 %   | 68.00 %   |
| 6 | 8EB4755F(@n6), 10.1.54.41  | 10:20:01 | 8    | 0.07 %   | 87.00 %   |
| 7 | 3696A541(@n7), 10.1.54.41  | 10:42:48 | 8    | 0.63 %   | 67.00 %   |
| 8 | D354BED1(@n8), 10.1.54.41  | 10:42:57 | 8    | 0.23 %   | 59.00 %   |
+-------------------------------------------------------------------------+
```

-EOF-

Tao Wu@CA, USA
